name: ğŸš€ Deploy to VPS - BNSP Project

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ”‘ Deploy to VPS
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: 103.23.199.68
        username: bnsp4
        password: Excellent!123@#
        script: |
          echo "=== ğŸš€ STARTING DEPLOYMENT ==="
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”§ Branch: $GITHUB_REF"
          
          # Navigate to project directory
          cd /home/bnsp4/my-app
          echo "ğŸ“ Current directory: $(pwd)"
          
          # Pull latest code from GitHub
          echo "ğŸ“¥ Pulling latest code from GitHub..."
          git fetch origin
          git reset --hard origin/main
          
          # List files to verify
          echo "ğŸ“‹ Files in directory:"
          ls -la
          
          # Build Docker image
          echo "ğŸ³ Building Docker image..."
          docker build -t my-app:latest .
          
          # Stop and remove old container if exists
          echo "ğŸ›‘ Stopping old container..."
          docker stop my-app-container || true
          docker rm my-app-container || true
          
          # Run new container
          echo "â–¶ï¸ Starting new container..."
          docker run -d \
            --name my-app-container \
            -p 80:80 \
            --restart unless-stopped \
            my-app:latest
          
          # Wait for container to start
          echo "â³ Waiting for container to start..."
          sleep 10
          
          # Verify deployment
          echo "âœ… Verifying deployment..."
          docker ps
          
          # Test website
          echo "ğŸŒ Testing website..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost || echo "000")
          echo "ğŸ“Š HTTP Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
            echo "ğŸ“ Website: http://103.23.199.68"
          else
            echo "âš ï¸ Website might be starting... Check logs:"
            docker logs my-app-container
          fi
          
          echo "=== âœ… DEPLOYMENT COMPLETED ==="

    - name: ğŸ“Š Deployment Status
      run: |
        echo "ğŸ¤– GitHub Actions workflow completed"
        echo "ğŸ” Check website: http://103.23.199.68"
        echo "ğŸ“ˆ Check monitoring: http://103.23.199.68:3000"